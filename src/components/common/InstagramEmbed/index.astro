---
import { getCurrentLanguage } from '../../../i18n/utils';
import LazyImage from '../LazyImage.astro';

export interface Props {
  postUrl: string;
  width?: string;
  height?: string;
  className?: string;
  fallbackImageUrl?: string;
  alt?: string;
}

const { 
  postUrl, 
  width = "100%", 
  height = "auto",  
  className = "",
  fallbackImageUrl = "",
  alt = "Instagram Post"
} = Astro.props;

// Extraer el ID del post
function extractInstagramId(url: string): string {
  const patterns = [
    /instagram\.com\/p\/([\w-]+)/i,
    /instagram\.com\/reel\/([\w-]+)/i,
    /instagram\.com\/tv\/([\w-]+)/i
  ];
  
  for (const pattern of patterns) {
    const match = url.match(pattern);
    if (match && match[1]) {
      return match[1].split(/\?|\//)[0];
    }
  }
  
  const urlParts = url.split('/');
  return urlParts[urlParts.length - 1].split('?')[0];
}

const postId = extractInstagramId(postUrl);
const embedUrl = `https://www.instagram.com/p/${postId}/embed/captioned/?hidecaption=0`;
---

<!-- Contenedor principal responsive -->
<div 
  class={`instagram-embed-container ${className}`}
  style="width: 100%; max-width: 100vw;"
>
  <!-- Contenedor del iframe con altura din치mica -->
  <div class="w-full min-h-[500px] h-[600px] max-h-[800px] sm:h-[650px] md:h-[600px] lg:h-[650px] xl:h-[700px] rounded-lg sm:rounded-xl overflow-hidden bg-gray-50 shadow-sm hover:shadow-md transition-all duration-300 border border-gray-200">
    
    <!-- Iframe con dimensiones responsivas -->
    <iframe 
      src={embedUrl}
      class="w-full h-full border-0"
      frameborder="0" 
      scrolling="no"
      allowtransparency="true"
      allow="encrypted-media"
      loading="lazy"
      title="Instagram Post"
      sandbox="allow-scripts allow-same-origin allow-popups"
      onload="
        try {
          // Intentar ajustar din치micamente
          const iframe = this;
          const container = iframe.closest('.instagram-embed-container');
          
          // Verificar si el iframe carg칩 correctamente
          setTimeout(() => {
            try {
              if (iframe.contentDocument && iframe.contentDocument.body) {
                // Ocultar fallback si existe
                const fallback = container.querySelector('.instagram-fallback');
                if (fallback) fallback.style.display = 'none';
              }
            } catch(e) {
              // Error de CORS, mantener fallback oculto
            }
          }, 1000);
        } catch(e) {
          console.log('Error loading Instagram embed:', e);
        }
      "
      onerror="
        this.style.display = 'none';
        const container = this.closest('.instagram-embed-container');
        const fallback = container.querySelector('.instagram-fallback');
        if (fallback) fallback.style.display = 'block';
      "
    ></iframe>
    
    <!-- Fallback simplificado -->
    <div class="instagram-fallback absolute inset-0 bg-gray-50 hidden flex-col items-center justify-center p-4 text-center">
      {fallbackImageUrl ? (
        <a href={postUrl} target="_blank" rel="noopener noreferrer" class="block w-full h-full">
          <LazyImage 
            src={fallbackImageUrl} 
            alt={alt}
            class="w-full h-full object-cover"
            loading="lazy"
          />
          <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent flex items-end p-4">
            <span class="text-white text-sm font-medium">Ver en Instagram</span>
          </div>
        </a>
      ) : (
        <div class="p-6">
          <div class="w-12 h-12 mb-4 mx-auto">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#888" stroke="#888" stroke-width="1">
              <rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect>
              <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path>
              <line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line>
            </svg>
          </div>
          <p class="text-gray-600 mb-4">Contenido de Instagram no disponible</p>
          <a 
            href={postUrl} 
            target="_blank" 
            rel="noopener noreferrer"
            class="inline-flex items-center gap-2 bg-[#E1306C] text-white px-4 py-2 rounded-lg hover:bg-[#C13584] transition-colors"
          >
            <span>Ver en Instagram</span>
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm6.066 9.645c.183 4.04-2.83 8.544-8.164 8.544-1.622 0-3.131-.476-4.402-1.291 1.524.18 3.045-.244 4.252-1.189-1.256-.023-2.317-.854-2.684-1.995.451.086.895.061 1.298-.049-1.381-.278-2.335-1.522-2.304-2.853.388.215.83.344 1.301.359-1.279-.855-1.641-2.544-.889-3.835 1.416 1.738 3.533 2.881 5.92 3.001-.419-1.796.944-3.527 2.799-3.527.826 0 1.573.349 2.098.907.654-.128 1.27-.368 1.824-.697-.215.671-.67 1.233-1.263 1.589.581-.07 1.135-.224 1.649-.453-.384.578-.87 1.084-1.433 1.489z"/>
            </svg>
          </a>
        </div>
      )}
    </div>
    
  </div>
</div>

<style>
  .instagram-embed-container {
    width: 100%;
    max-width: 100%;
    margin: 0 auto;
    position: relative;
  }
  
  /* Asegurar que el iframe sea responsive */
  iframe[src*="instagram.com"] {
    min-height: 500px !important;
  }
  
  /* Para pantallas muy peque침as */
  @media (max-width: 365px) {
    .instagram-embed-container > div {
      min-height: 450px !important;
      height: 450px !important;
    }
    
    iframe[src*="instagram.com"] {
      min-height: 450px !important;
    }
  }
  
  /* Para pantallas medianas */
  @media (min-width: 366px) and (max-width: 639px) {
    .instagram-embed-container > div {
      min-height: 500px !important;
      height: 500px !important;
    }
  }
  
  /* Smooth transitions */
  .instagram-fallback {
    transition: opacity 0.3s ease;
  }
</style>