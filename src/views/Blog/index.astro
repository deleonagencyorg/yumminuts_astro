---
import Layout from '../../layouts/MainLayout.astro';
import { type Locale } from '../../i18n/i18n';
import BlogCard from '../../components/blog/BlogCard.astro';
import BlogCardSkeleton from '../../components/blog/BlogCardSkeleton.astro';
import Breadcrumb from '../../components/common/Breadcrumb/Breadcrumb.astro';
import { fade } from 'astro:transitions';
import BlogCarouselHero from '../../components/blog/BlogCarouselHero.astro';

interface Props {
  blogPosts: Array<{
    id: string;
    slug: string;
    title: string;
    summary: string;
    image: string;
    published_date: string;
  }>;
  currentLang: Locale;
  isLoading?: boolean;
}

const { blogPosts, currentLang, isLoading = false } = Astro.props;

function estimateReadMinutes(text: string): number {
  if (!text) return 1;
  const words = text.trim().split(/\s+/).length;
  return Math.max(1, Math.ceil(words / 200));
}

const noPostsText = currentLang === 'es' ? 'No hay entradas disponibles por el momento.' : 'No posts available at this time.';
---

<Layout title="Blog" class="bg-white" description="Latest blog posts">
  
  <!-- Hero Carousel -->
  
  <div class="container mx-auto px-4 pt-6">
    <Breadcrumb bgColor="bg-white" textColor="text-black" hoverColor="hover:text-black" />
    
    <div class="flex items-center justify-center text-center mb-12 md:h-64 md:rounded-none rounded-2xl"  style="background-image: url('https://snack.yummiespromociones.com/yumminuts/bgrecipes.png'); background-size: cover; background-position: center; background-repeat: no-repeat;" transition:animate={fade({ duration: '0.5s' })}>
      <h1 class="font-heading text-3xl md:text-6xl font-bold mb-4 text-primary py-4 ">{currentLang === 'es' ? 'Descubre las noticias y actualizaciones mas importantes.' : 'Discover the latest news and updates.'}</h1>
    
    </div>
    {(!blogPosts || blogPosts.length === 0) ? (
      <div class="w-full flex items-center justify-center py-8">
        <div class="w-full bg-gray-100 rounded-2xl flex items-center justify-center text-center mx-auto h-48 md:h-64 lg:h-80">
          <p class="text-gray-600 text-base md:text-lg font-semibold px-4">{noPostsText}</p>
        </div>
      </div>
    ) : (
      <>
        <div id="last-news">
          <a href={`/${currentLang}/blog/${blogPosts[0].slug || blogPosts[0].id}`} class="block group">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-start">
              <!-- Imagen destacada -->
              <div class="w-full">
                <div class="relative overflow-hidden rounded-2xl w-full aspect-[4/3]">
                  <img src={blogPosts[0].image} alt={blogPosts[0].title} class="w-full h-full object-cover" />
                </div>
              </div>

              <!-- Contenido -->
              <div class="w-full">
                <div class="flex items-center gap-2 text-sm text-gray-500 mb-2">
                  <span class="inline-flex items-center gap-1">
                    <span class="h-2 w-2 rounded-full bg-gray-300 inline-block"></span>
                    {currentLang === 'es' ? 'Undécima Edición' : 'Eleventh Edition'}
                  </span>
                  <span>•</span>
                  <span>{currentLang === 'es' ? 'Hace 15 minutos' : '15 minutes ago'}</span>
                </div>
                <h2 class="font-heading text-2xl md:text-4xl font-bold text-black leading-tight mb-3">
                  {blogPosts[0].title}
                </h2>
                <p class="text-gray-700 mb-4">
                  {blogPosts[0].summary}
                </p>
                <div class="flex items-center gap-3 text-sm">
                  <span class="text-red-600 font-semibold">{currentLang === 'es' ? 'Nuevo' : 'New'}</span>
                  <span>•</span>
                  <span class="text-gray-500">{currentLang === 'es' ? '5 minutos de lectura' : '5 min read'}</span>
                </div>
              </div>
            </div>
          </a>
        </div>

        <!-- Carousel horizontal de noticias (resto) -->
        <div class="relative py-6 mx-auto max-w-7xl mt-12">
          <h2 class="text-black font-heading text-4xl md:text-5xl font-bold text-left mb-8">{currentLang === 'es' ? 'Últimas Noticias' : 'Latest News'}</h2>
          <!-- Botones -->
          <button type="button" aria-label="prev" id="newsPrev" class="flex absolute left-2 md:-left-3 top-1/2 -translate-y-1/2 z-10 bg-primary text-white rounded-md w-9 h-9 md:w-10 md:h-10 items-center justify-center shadow hover:opacity-90">❮</button>
          <button type="button" aria-label="next" id="newsNext" class="flex absolute right-2 md:-right-3 top-1/2 -translate-y-1/2 z-10 bg-primary text-white rounded-md w-9 h-9 md:w-10 md:h-10 items-center justify-center shadow hover:opacity-90">❯</button>

          <div id="newsTrack" class="flex gap-6 overflow-x-auto snap-x snap-mandatory scroll-smooth pb-2 no-scrollbar py-6">
            {isLoading
              ? [...Array(8)].map((_, i) => <BlogCardSkeleton key={i} />)
              : blogPosts.slice(1).map((post, i) => (
                  <div class="w-1/2 md:w-1/4 flex-shrink-0 snap-start">
                    <BlogCard 
                      id={post.id}
                      image={post.image}
                      title={post.title}
                      slug={post.slug || post.id}
                      summary={post.summary}
                      minutes={estimateReadMinutes(post.summary)}
                      isNew={i < 3}
                    />
                  </div>
                ))
            }
          </div>
        </div>
      </>
    )}
  </div>
  
</Layout>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const track = document.getElementById('newsTrack');
    const prev = document.getElementById('newsPrev');
    const next = document.getElementById('newsNext');
    if (!track || !prev || !next) return;
    function cardWidth() {
      const isDesktop = window.matchMedia('(min-width: 768px)').matches;
      return track.clientWidth * (isDesktop ? 0.25 : 0.5);
    }
    prev.addEventListener('click', () => {
      track.scrollBy({ left: -cardWidth(), behavior: 'smooth' });
    });
    next.addEventListener('click', () => {
      track.scrollBy({ left: cardWidth(), behavior: 'smooth' });
    });
  });
</script>

<style>
  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 20px;
  }
  
  .hero-container {
    width: 100%;
    max-height: 300px;
    overflow: hidden;
    margin-bottom: 2rem;
  }
  
  .hero-image {
    width: 100%;
    height: 300px;
    background-image: url('https://snack.yummiespromociones.com/snacksyummies/bgondas.webp');
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
  }
  
  @media (max-width: 768px) {
    .hero-image {
      height: 200px;
    }
  }
  
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>
