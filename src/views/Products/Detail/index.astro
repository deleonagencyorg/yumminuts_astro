---
// src/views/Products/Detail/index.astro
import { t } from '../../../i18n/i18n';
import type { Locale } from '../../../i18n/i18n';
import './styles.css';
import { initProductDetail } from './scripts.js';
import ProductsCarousel from '../../../components/common/ProductsCarousel/index.astro';
import LazyImage from '../../../components/common/LazyImage.astro';
import ProductImageCarousel from '../../../components/common/ProductImageCarousel/index.astro';
import ProductBenefits from '../../../components/common/ProductBenefits/index.astro';
import RelatedProducts from '../../../components/common/RelatedProducts/index.astro';
import Categories from '../../../components/common/Categories/index.astro';
import Discover from '../../../components/common/Discover/index.astro';


// Interfaces locales
interface ProductSize {
  value: string;
  image: string;
}

interface Stockist {
  id: string;
  name: string;
  icon: string;
  link: string;
}

interface Product {
  id: string;
  name: string;
  category: string;
  image: string;
  available?: string;
  background_image: string;
  background_color: string;
  header_text_color: string;
  color_button: string;
  sizes: ProductSize[];
  description?: string;
  short_description?: string;
  presentaciones?: Array<{
    value: string;
    icono: string;
  }>;
  // relatedProducts es opcional ya que no existe en la estructura actual
  relatedProducts?: string[];
  weight?: string[];
}

const { currentLang, productId } = Astro.props;

// Obtener datos desde traducciones
const productsAssets = t('home', { namespace: 'products', locale: currentLang }) || {};
const products = t('items', { namespace: 'products', locale: currentLang as Locale }) || [];
const stockists = t('stockist', { namespace: 'products', locale: currentLang as Locale }) || [];
const product = products.find((item: Product) => item.id === productId);
const brandsAssets = t('', { namespace: 'brands', locale: currentLang }) || {};
const newsAssets =  t('', { namespace: 'news', locale: currentLang }) || {};
const brandsList = brandsAssets.brands || [];
const nutsBrand = brandsList.find((brand: any) => brand.id === 'yumminuts');
const nutsCategories = nutsBrand?.categories || [];
const discoverAssets = t('discover', { namespace: 'common', locale: currentLang }) || {};


// Si el producto no existe, lanzar error
if (!product || Object.keys(product).length === 0) {
  throw new Error(t('errors.product_not_found', { locale: currentLang }));
}

// Asegurar que todas las propiedades necesarias existan
const safeProduct: Product = {
  id: product.id || '',
  name: product.name || '',
  category: product.category || '',
  image: product.image || '',
  background_image: product.background_color || '',
  background_color: product.background_color || '',
  header_text_color: product.header_text_color || '#000000',
  color_button: product.color_button || '#000000',
  sizes: Array.isArray(product.sizes) ? product.sizes : [],
  available: product.available || '',
  description: product.description || '',
  weight: Array.isArray(product.weight) ? product.weight : [],
  
};

// Obtener todos los productos como un array
const productsData = t('items', { locale: currentLang, namespace: 'products' }) || [];
const allProductsArray = Array.isArray(productsData) ? productsData : [];

// Filtrar productos relacionados - simplificado para evitar errores
let relatedProducts: any[] = [];
// Solo usar productos de la misma categoría si hay más de 1 producto
if (allProductsArray.length > 1) {
  relatedProducts = allProductsArray
    .filter((p: any) => p.id !== productId)
    .slice(0, 3);
}

// Preparar imágenes para el carousel (usando la imagen principal y variaciones)
const carouselImages = [
  safeProduct.image,
  // Para demo, duplicamos la imagen. En producción, estas serían diferentes vistas del producto
  safeProduct.image,
  safeProduct.image,
  safeProduct.image,
  safeProduct.image
];

// Preparar beneficios del producto
const productBenefits = [
  {
    icon: "/src/assets/gluten-free.svg",
    text: currentLang === 'es' ? "100% libre de gluten" : "100% gluten free",
    alt: "Gluten free icon"
  },
  {
    icon: "/src/assets/gluten-free.svg", 
    text: currentLang === 'es' ? "Sin conservantes" : "No preservatives",
    alt: "No preservatives icon"
  },
  {
    icon: "/src/assets/gluten-free.svg",
    text: currentLang === 'es' ? "Natural" : "Natural",
    alt: "Natural icon"
  }
];


---

{safeProduct.background_color && (
  <article id="product-detail" class="product-detail pt-12 md:pt-29 pb-32 md:bg-[image:var(--desktop-bg)] bg-cover bg-center bg-[var(--mobile-bg)] relative" 
    style={`
      --mobile-bg: ${safeProduct.background_color};
      --desktop-bg: url('${safeProduct.background_color}');
    `}
    transition:animate="slide"
  >
    <div class="md:mt-[0] container mx-auto px-6 py-5 flex flex-col md:flex-row gap-5">
      {/* Product Image Carousel */}
      <div class="hidden md:flex md:flex-col md:justify-start md:items-center md:pr-4">
        <ProductImageCarousel 
          images={carouselImages}
          productName={safeProduct.name}
          activeImageIndex={0}
          className="max-h-[605px] overflow-y-auto"
        />
      </div>
      
      {/* Contenedor de la imagen del lado izquierdo */}
      <div class="relative flex justify-center items-center w-full md:w-[505px] p-4 md:px-28 md:py-16 rounded-[85px] gap-2 cursor-pointer overflow-hidden group" style={{ backgroundColor: safeProduct.color_button }}>
        {/* Overlay para el efecto de oscurecimiento */}
        <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-30 transition-all duration-300 rounded-[85px]"></div>
        <img id="product-image" class="relative z-10 max-w-full h-auto transition-transform duration-300 group-hover:scale-110" src={safeProduct.image} alt={safeProduct.name} transition:name={`product-image-${safeProduct.id}`} />
      </div>
      
      {/* Contenido del lado derecho */}
      <div class="w-full md:w-1/2 md:h-[605px] h-auto">
      <h4 class="md:text-2xl text-xl font-sans uppercase " style={{ color: safeProduct.header_text_color }}>{safeProduct.category}</h4>
        <div class="flex justify-between items-center mb-6">
          
          <h3 class="md:text-2xl text-xl font-sans font-semibold uppercase " style={{ color: safeProduct.header_text_color }}>{safeProduct.name}</h3>
          <a 
            href="#" 
            class="flex h-[54px] justify-center items-center gap-[10px] px-10 py-5 rounded-[47px] bg-primary border whitespace-nowrap uppercase font-title text-lg font-medium text-white"
            style={{  borderColor: safeProduct.header_text_color}}
          >
            {currentLang === 'es' ? 'ENCUÉNTRALO' : 'FIND IT'}
          </a>
        </div>
        
        <p
          class=" md:text-lg text-lg font-text font-medium gap-30 py-5"
          style={{ color: safeProduct.header_text_color }}
        >
            {safeProduct.description}
        </p>

        {/* Product Benefits Section */}
        <div class="my-8">
          <ProductBenefits 
            title={currentLang === 'es' ? 'Beneficios' : 'Benefits'}
            benefits={productBenefits}
            titleColor={safeProduct.header_text_color}
            textColor="#385cad"
            className="w-full"
          />
        </div>

        {/* Related Products Section */}
        {relatedProducts.length > 0 && (
          <div class="my-8">
            <RelatedProducts 
              products={relatedProducts}
              currentLang={currentLang}
              title={currentLang === 'es' ? '' : ''}
              titleColor={safeProduct.header_text_color}
              className="w-full"
            />
          </div>
        )}

        
      </div>
    </div>
  </article>
)}

<!-- Sección de Productos Nuts -->
    {nutsCategories.length > 0 && (
      <section class="w-full py-2 bg-white pt-10">
        <div class="container mx-auto ">
          <Categories 
            products={nutsCategories}
            title="Categorías"
          />
        </div>
      </section>
  )}

  <section id="discover" class="w-full bg-white py-16">
      <Discover title={discoverAssets.title} images={discoverAssets.images || []} />
  </section>


<script>
  // Este script se ejecuta solo en el navegador
  import { initProductDetail } from './scripts.js';
  document.addEventListener('DOMContentLoaded', () => {
    initProductDetail();
  });
</script>
